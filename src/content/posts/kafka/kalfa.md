---
title: Kafka
published: 2025-01-02
description: "kafka学习"
tags: ["kafka"]
category: Tech
draft: true
---
# 一些概念
- Kafka作为一个集群运行在一个或多个数据中心服务器上
- Kafka集群中每条记录都包含**一个键、一个值和一个时间戳**

# 核心API
- 生产者API
  将数据流发布到Kafka的Topic（主题）中
- 消费者API
  从Topic中读取数据流并处理。
- 流处理API
  将输入Topic的数据流处理后，输出到另一个Topic（类似实时流水线）。
- 连接器API
  将Kafka和其他系统（如数据库）自动连接，无需重复写代码。

# Topics和Partitions分区
- 一个主题可以看作是一类消息（对于生产者来说是发布记录的类别，对于消费者来说是订阅源名称）。**每个主题被分成多个区**。
![alt text](assets/1216496-20190116165958027-887762707.png)
- 每个分区都有一个有序的、不可变的记录序列
- 数据持久化（保留期配置）​​：Kafka会持久保存所有消息（无论是否被消费过），但保留时间可通过参数配置。超过保留期的数据会被自动删除以释放空间。
- 每个消费者保留的唯一元数据是该消费者在日志中的偏移或位置。
![alt text](assets/1216496-20190116171533633-1400193284.png)

# leader和follower
- 分区副本机制：**每个Partition在kafka集群中有副本**。这里面挑一个作为leader，其他的作为follower
- leader
  + 所有生产者的写入请求和消费者的读取请求都由 Leader 副本处理。
  + 每个分区只有一个 Leader 副本。
- follower
  + Follower 副本会从 Leader 副本拉取（Pull）消息，保持与 Leader 的数据一致。
  + 如果 Leader 副本宕机，某个 Follower 会被选举为新的 Leader。
  + 如果一个 Follower 长时间未同步（例如网络故障或 Broker 宕机），会被移出 ISR(In-Sync-Replicas)。
  + 通过一些参数来保持同leader同步的时间
- 优点：**在保证高吞吐量的同时，具备容错能力和数据可靠性**

# Producers
允许将数据发送到指定的topic和partition。
指定Partition时允许使用RR等算法。

# Consumers
- 每个消费者都必须属于一个消费者组
- 组内消费共享分区
  **同一Topic的每个分区（Partition）只能被组内的​​一个消费者​​消费。
  但是，每个分区可以不止被一个消费者组消费**
- 组间消费完全独立
  **不同消费者组之间互不影响，每个组独立消费Topic的全部数据。**
![alt text](assets/1216496-20190116170227082-737238469.png)
> Producer和Consumer读取与写入日志的顺序
> - 对于生产者而言：发送到分区消息会按照消息的接收顺序追加
> - 对于消费者而言：它们消费消息的顺序和日志中消息顺序一致

# Kafka与传统的Queuing与Pub-Sub模式的区别
1. **传统的Queuing**:
  + 逻辑：消息被发送到队列，由单个消费者处理（点对点模式）
  + 问题：
    + 拓展性差：队列拓展能力受限于单个消费者能力
    + **消息不可复用**：消息从队列中删除之后，无法被其他消费者组复用
2. **Pub-Sub模式**：
  + 逻辑：消息广播到所有订阅者，允许多个消费者接收相同消息。
  + 问题：
    + 消息缺乏持久化能力
    + 无消息重播：消费者无法回溯消息历史数据
    + **负载均衡问题**：订阅者之间难以动态分配消息处理任务，达到负载均衡。
3. **Kafka**
  + 融合队列与发布-订阅的混合
    - 负载均衡消费：每个分区仅由组内一个消费者处理
    - 独立消费全量数据：不同消费者组独立消费各主题数据
  + 高吞吐与水平拓展
    - Topic被划分为分区，每个分区独立处理读写请求
    - 生产者和消费者可以并行操作多个分区，实现线性拓展
  + 持久化与消息重播
    - 持久化：无论有无消费，都会进行存储一段时间
    - 消息重播：可以重置offset，进行故障恢复和数据回溯
  + 强顺序性与一致性
    - 同一分区的消息严格按写入顺序消费（事件溯源、事务日志等场景）
  + 容错与高可用
    - 一个Partition具有多个副本，高容错
    - Leader-Follower机制能够自动处理故障切换

